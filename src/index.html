<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ReititApp</title>
  <base href="/">

  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="manifest" href="assets/manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- iOS, IE & old browser manifest polyfills -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Reitit">
  <meta name="apple-mobile-web-app-title" content="Reitit">
  <meta name="theme-color" content="#1976D2">
  <meta name="msapplication-navbutton-color" content="#1976D2">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="msapplication-starturl" content="/">

  <link rel="icon" sizes="76x76" href="assets/icons/app-icon/app-icon-ipad.png">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/icons/app-icon/app-icon-ipad.png">
  <link rel="icon" sizes="152x152" href="assets/icons/app-icon/app-icon-ipad@2x.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/icons/app-icon/app-icon-ipad@2x.png">
  <link rel="icon" sizes="120x120" href="assets/icons/app-icon/app-icon-iphone@2x.png">
  <link rel="apple-touch-icon" sizes="120x120" href="assets/icons/app-icon/app-icon-iphone@2x.png">
  <link rel="icon" sizes="180x180" href="assets/icons/app-icon/app-icon-iphone@3x.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/app-icon/app-icon-iphone@3x.png">

  <noscript>
    <h1>This application requires JavaScript to run</h1>
    <p>We are deeply sorry, but this application only runs on recent browsers supporting JavaScript.</p>
  </noscript>
</head>
<body>
  <app-root></app-root>
  <script>
    const registrationsURL = location.host.startsWith("localhost")
    ? "http://localhost:5001/reitit-app/us-central1/registrations"
    : "https://us-central1-reitit-app.cloudfunctions.net/registrations";
  
  /**
   * Request PUSH subscription from the existing sw registration handle.
   * Reuses existing registration if available.
   */
  function requestPushSubscription(registration) {
    if (!registration.pushManager) {
      console.log('pushManager not supported on this device.');
      return;
    }

    return registration.pushManager
      .getSubscription()
      .then(subscription => {
        // If a subscription was found, return it.
        if (subscription) {
          return subscription;
        }
  
        // Otherwise, subscribe the user (userVisibleOnly allows to specify that we don't plan to
        // send notifications that don't have a visible effect for the user).
        return registration.pushManager.subscribe({ userVisibleOnly: true });
      })
      .then(subscription => {
        // Show curl command to send the notification on the page.
        console.log("Raw subscription endpoint", subscription.endpoint);
  
        const rawKey = subscription.getKey ? subscription.getKey("p256dh") : "";
        const key = rawKey
          ? btoa(String.fromCharCode.apply(null, new Uint8Array(rawKey)))
          : "";
        const rawAuthSecret = subscription.getKey
          ? subscription.getKey("auth")
          : "";
        const authSecret = rawAuthSecret
          ? btoa(String.fromCharCode.apply(null, new Uint8Array(rawAuthSecret)))
          : "";
        const endpoint = subscription.endpoint;
  
        // Send the subscription details to the server using the Fetch API.
        fetch(registrationsURL, {
          method: "post",
          headers: { "Content-type": "application/json" },
          body: JSON.stringify({
            endpoint: subscription.endpoint,
            userKey: key,
            userAuth: authSecret
          })
        });
      });
  }
  
  // Register service worker if available
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js');
      navigator.serviceWorker.ready.then(requestPushSubscription);
    });
  }  
  </script>
</body>
</html>
